# üîê WorldMates Crypto Migration Guide

## –ü–µ—Ä–µ—Ö–æ–¥ —Å AES-128-ECB –Ω–∞ AES-256-GCM

–≠—Ç–æ—Ç –≥–∞–π–¥ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ AES-128-ECB –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π AES-256-GCM —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | AES-128-ECB (—Å—Ç–∞—Ä–æ–µ) | AES-256-GCM (–Ω–æ–≤–æ–µ) |
|---------------|---------------------|---------------------|
| **–†–∞–∑–º–µ—Ä –∫–ª—é—á–∞** | 128 –±–∏—Ç | 256 –±–∏—Ç |
| **–†–µ–∂–∏–º** | ECB (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) | GCM (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) |
| **IV (Initialization Vector)** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (12 –±–∞–π—Ç, —Å–ª—É—á–∞–π–Ω—ã–π) |
| **Authentication Tag** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (16 –±–∞–π—Ç) |
| **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–º–µ–Ω—ã** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫** | üî¥ –ù–∏–∑–∫–∞—è | üü¢ –í—ã—Å–æ–∫–∞—è |

---

## üöÄ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### Android (Kotlin)

1. **–°–æ–∑–¥–∞–Ω `EncryptionUtility.kt`**
   - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ AES-256-GCM
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ IV
   - Authentication tag –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

2. **–û–±–Ω–æ–≤–ª–µ–Ω `DecryptionUtility.kt`**
   - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (v1=ECB, v2=GCM)
   - –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `Message`**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `iv`, `tag`, `cipher_version`

### PHP (–°–µ—Ä–≤–µ—Ä)

4. **–°–æ–∑–¥–∞–Ω `crypto_helper.php`**
   - –ö–ª–∞—Å—Å `CryptoHelper` —Å –º–µ—Ç–æ–¥–∞–º–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤ (ECB –∏ GCM)
   - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (ECB):
```json
{
  "id": 123,
  "text": "aGVsbG8gd29ybGQ=",  // Base64 encrypted
  "time": 1754067404
}
```

### –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (GCM):
```json
{
  "id": 123,
  "text": "aGVsbG8gd29ybGQ=",     // Base64 encrypted
  "time": 1754067404,
  "iv": "random_iv_base64",      // 12-–±–∞–π—Ç–æ–≤—ã–π IV
  "tag": "auth_tag_base64",      // 16-–±–∞–π—Ç–æ–≤—ã–π authentication tag
  "cipher_version": 2            // –í–µ—Ä—Å–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞
}
```

---

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Android

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–æ–≤–æ–µ):

```kotlin
val plaintext = "Hello World"
val timestamp = System.currentTimeMillis() / 1000

val encryptedData = EncryptionUtility.encryptMessage(plaintext, timestamp)

if (encryptedData != null) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
    val message = mapOf(
        "text" to encryptedData.encryptedText,
        "iv" to encryptedData.iv,
        "tag" to encryptedData.tag,
        "cipher_version" to encryptedData.cipherVersion,
        "time" to timestamp
    )
}
```

### –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏):

```kotlin
// –î–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (GCM):
val decrypted = DecryptionUtility.decryptMessage(
    encryptedText = message.encryptedText,
    timestamp = message.timeStamp,
    iv = message.iv,
    tag = message.tag,
    cipherVersion = message.cipherVersion
)

// –î–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (ECB) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è:
val decrypted = DecryptionUtility.decryptMessage(
    encryptedText = message.encryptedText,
    timestamp = message.timeStamp
)
```

---

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ PHP

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

```php
require_once('includes/crypto_helper.php');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ GCM
if (!CryptoHelper::isGCMSupported()) {
    die('AES-GCM not supported on this server!');
}
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–Ω–æ–≤–æ–µ):

```php
$plaintext = "Hello World";
$timestamp = time();

$encrypted = CryptoHelper::encryptGCM($plaintext, $timestamp);

if ($encrypted !== false) {
    $message = array(
        'text' => $encrypted['text'],
        'iv' => $encrypted['iv'],
        'tag' => $encrypted['tag'],
        'cipher_version' => $encrypted['cipher_version'],
        'time' => $timestamp
    );

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É
    echo json_encode($message);
}
```

### –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ):

```php
// –î–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (GCM):
$decrypted = CryptoHelper::decrypt(
    $message['text'],
    $message['time'],
    $message['iv'] ?? null,
    $message['tag'] ?? null,
    $message['cipher_version'] ?? null
);

// –î–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (ECB):
$decrypted = CryptoHelper::decrypt(
    $message['text'],
    $message['time']
);

if ($decrypted !== false) {
    echo $decrypted;
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:

```php
// –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
$encrypted = wo_encrypt_message_gcm("Hello World", time());

// –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
$decrypted = wo_decrypt_message(
    $ciphertext,
    $timestamp,
    $iv,
    $tag,
    $cipherVersion
);
```

---

## üîÑ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ)
- ‚úÖ –°–æ–∑–¥–∞–Ω EncryptionUtility.kt
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω DecryptionUtility.kt
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å Message
- ‚úÖ –°–æ–∑–¥–∞–Ω crypto_helper.php

### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
1. –û–±–Ω–æ–≤–∏—Ç—å `MessagesViewModel` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (ECB)
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (GCM)

### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ PHP API
1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å `crypto_helper.php` –≤–æ –≤—Å–µ—Ö endpoint'–∞—Ö
2. –ó–∞–º–µ–Ω–∏—Ç—å `openssl_encrypt()` –Ω–∞ `CryptoHelper::encryptGCM()`
3. –û–±–Ω–æ–≤–∏—Ç—å:
   - `send-message.php`
   - `get_user_messages.php`
   - `get_chats.php`
   - `page_chat.php`
   - `group_chat.php`
   - `get-site-settings.php`
   - `phone/get_users_list.php`

### –≠—Ç–∞–ø 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ
1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
2. –í—ã–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –∏ –æ—à–∏–±–æ–∫
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ GCM –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –≠—Ç–∞–ø 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
1. –í—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ GCM
2. –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ ECB (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
3. –ß–µ—Ä–µ–∑ 3-6 –º–µ—Å—è—Ü–µ–≤ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É ECB

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PHP –≤–µ—Ä—Å–∏—é >= 7.1 (–¥–ª—è GCM)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `openssl` —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
- [ ] –¢–µ—Å—Ç `CryptoHelper::isGCMSupported()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
- [ ] –ó–∞–ª–∏—Ç—å `crypto_helper.php` –≤ `api-worldmates/includes/`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ PHP —Ñ–∞–π–ª—ã —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º

### –ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º Android:
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ–¥–∏–∞-—Ñ–∞–π–ª—ã

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –Ω–∞ Android:

```kotlin
Log.d("Crypto", "Message version: ${message.cipherVersion ?: "ECB (legacy)"}")
Log.d("Crypto", "Has IV: ${message.iv != null}")
Log.d("Crypto", "Has Tag: ${message.tag != null}")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ PHP:

```php
error_log("Cipher version: " . ($message['cipher_version'] ?? 'ECB (legacy)'));
error_log("Has IV: " . (isset($message['iv']) ? 'yes' : 'no'));
error_log("Has Tag: " . (isset($message['tag']) ? 'yes' : 'no'));
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (ECB) –±—É–¥—É—Ç —á–∏—Ç–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ `cipher_version` –≤ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
3. **IV —É–Ω–∏–∫–∞–ª–µ–Ω**: –ö–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π IV
4. **Authentication –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è**: –ï—Å–ª–∏ GCM –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è, —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω–æ
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: GCM –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ ECB, –Ω–æ —Ä–∞–∑–Ω–∏—Ü–∞ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [NIST GCM Specification](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf)
- [OpenSSL GCM Documentation](https://www.php.net/manual/en/function.openssl-encrypt.php)
- [Android Cipher GCM](https://developer.android.com/reference/javax/crypto/Cipher)

---

## üéØ –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.

**–°—Ç–∞—Ç—É—Å**: ‚úÖ Android –≥–æ—Ç–æ–≤ | ‚è≥ PHP –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
