# üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è Socket.IO

## –ü—Ä–æ–±–ª–µ–º–∞

–ö–ª—ñ—î–Ω—Ç —É—Å–ø—ñ—à–Ω–æ:
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ Socket.IO
- ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `socket.emit('private_message', data)`

–ê–ª–µ **–ù–ï –æ—Ç—Ä–∏–º—É—î** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–∑–∞–¥!

## –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ

### –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π Node.js

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä—ñ
ps aux | grep node
netstat -tlnp | grep 449
```

–ú–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å Node.js –Ω–∞ –ø–æ—Ä—Ç—É 449.

### –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ Node.js

```bash
# –Ø–∫—â–æ —î PM2
pm2 logs

# –ê–±–æ –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º–∏
tail -f /var/log/nodejs/*.log

# –ê–±–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å –≤—Ä—É—á–Ω—É —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ª–æ–≥–∏
cd /path/to/nodejs
node main.js
```

**–®—É–∫–∞–π—Ç–µ:**
- `Socket connected` - –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è
- `private_message received` - –∫–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç—Ä–∏–º—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- `emit private_message` - –∫–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –Ω–∞–∑–∞–¥

### –ö—Ä–æ–∫ 3: –î–æ–¥–∞–π—Ç–µ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ listeners.js

–í—ñ–¥–∫—Ä–∏–π—Ç–µ `nodejs/listeners/listeners.js` —ñ –∑–Ω–∞–π–¥—ñ—Ç—å –æ–±—Ä–æ–±–Ω–∏–∫ `private_message`:

```javascript
// –ó–ù–ê–ô–î–Ü–¢–¨ –¶–ï–ô –ö–û–î:
socket.on('private_message', function(data) {
    // ... –∫–æ–¥ –æ–±—Ä–æ–±–∫–∏
});

// –î–û–î–ê–ô–¢–ï –ù–ê –ü–û–ß–ê–¢–ö–£ –§–£–ù–ö–¶–Ü–á:
socket.on('private_message', function(data) {
    console.log('üî• RECEIVED private_message from client:', {
        from_id: data.from_id,
        to_id: data.to_id,
        msg: data.msg,
        socket_id: socket.id
    });

    // ... —Ä–µ—à—Ç–∞ –∫–æ–¥—É
});
```

### –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –µ–º—ñ—Ç–∏—Ç—å—Å—è –ø–æ–¥—ñ—è –Ω–∞–∑–∞–¥

–í `nodejs/events/events.js` –∑–Ω–∞–π–¥—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `sendPrivateMessage` –∞–±–æ –ø–æ–¥—ñ–±–Ω—É:

```javascript
// –î–û–î–ê–ô–¢–ï –õ–û–ì–£–í–ê–ù–ù–Ø:
function sendPrivateMessage(data) {
    console.log('üöÄ EMITTING private_message to recipient:', {
        to_id: data.to_id,
        from_id: data.from_id,
        message_id: data.id
    });

    // –í–∞–∂–ª–∏–≤–æ: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ø–ö –µ–º—ñ—Ç–∏—Ç—å—Å—è
    // –í–∞—Ä—ñ–∞–Ω—Ç 1: –î–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
    io.to('user_' + data.to_id).emit('private_message', data);

    // –í–∞—Ä—ñ–∞–Ω—Ç 2: –î–æ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ —Ç–∞–∫–æ–∂ (—â–æ–± –≤—ñ–Ω –ø–æ–±–∞—á–∏–≤ —Å–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
    io.to('user_' + data.from_id).emit('private_message', data);

    console.log('‚úÖ Message emitted successfully');
}
```

### –ö—Ä–æ–∫ 5: –ö–†–ò–¢–ò–ß–ù–û! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∏—î–¥–Ω—É—î—Ç—å—Å—è –¥–æ room

–ö–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î `join` event, —Å–µ—Ä–≤–µ—Ä –º–∞—î –¥–æ–¥–∞—Ç–∏ socket –¥–æ room:

```javascript
socket.on('join', function(data) {
    console.log('üë§ User joining:', {
        user_id: data.user_id,
        access_token: data.user_id, // WoWonder –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î access_token —è–∫ user_id
        socket_id: socket.id
    });

    // –ö–†–ò–¢–ò–ß–ù–û: –î–æ–¥–∞—Ç–∏ –¥–æ room
    const room = 'user_' + getUserIdFromToken(data.user_id);
    socket.join(room);

    console.log('‚úÖ User joined room:', room);
});
```

## –ù–∞–π—ñ–º–æ–≤—ñ—Ä–Ω—ñ—à—ñ –ø—Ä–æ–±–ª–µ–º–∏:

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –ø—Ä–∏—î–¥–Ω—É—î—Ç—å—Å—è –¥–æ room

**–°–∏–º–ø—Ç–æ–º:** –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –µ–º—ñ—Ç—è—Ç—å—Å—è, –∞–ª–µ –Ω—ñ—Ö—Ç–æ —ó—Ö –Ω–µ –æ—Ç—Ä–∏–º—É—î

**–†—ñ—à–µ–Ω–Ω—è:** –í –æ–±—Ä–æ–±–Ω–∏–∫—É `join` –¥–æ–¥–∞–π—Ç–µ:

```javascript
socket.on('join', function(data) {
    // data.user_id —Ü–µ access_token (session hash)

    // –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ–≤–∏–π ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    db.query('SELECT user_id FROM wo_users WHERE access_token = ?', [data.user_id], function(err, results) {
        if (results && results.length > 0) {
            const userId = results[0].user_id;
            const room = 'user_' + userId;

            socket.join(room);
            console.log('User', userId, 'joined room', room);

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
            socket.userId = userId;
        }
    });
});
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–æ–¥—ñ—ó –µ–º—ñ—Ç—è—Ç—å—Å—è –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:** –ö–ª—ñ—î–Ω—Ç –æ—á—ñ–∫—É—î `private_message`, –∞ —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ –µ–º—ñ—Ç–∏—Ç–∏ `new_message` –∞–±–æ `private_message_page`

**–†—ñ—à–µ–Ω–Ω—è:** –í `events.js` –µ–º—ñ—Ç—å—Ç–µ –í–°–Ü –≤–∞—Ä—ñ–∞–Ω—Ç–∏:

```javascript
// –ï–º—ñ—Ç–∏–º–æ –≤ —É—Å—ñ—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
io.to('user_' + data.to_id).emit('private_message', messageData);
io.to('user_' + data.to_id).emit('new_message', messageData);
io.to('user_' + data.from_id).emit('private_message', messageData); // –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫—É —Ç–∞–∫–æ–∂
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:** –Ø–∫—ñ –ø–æ–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î —Å–µ—Ä–≤–µ—Ä

```javascript
const messageData = {
    id: message.id,
    from_id: message.from_id,
    to_id: message.to_id,
    text: message.text,        // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ç–µ–∫—Å—Ç
    time: message.time,        // UNIX timestamp
    media: message.media || '',
    // ... —ñ–Ω—à—ñ –ø–æ–ª—è
};
```

## –®–≤–∏–¥–∫–∏–π —Ç–µ—Å—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏:

–î–æ–¥–∞–π—Ç–µ –≤ `main.js` —Ç–µ—Å—Ç–æ–≤–∏–π –æ–±—Ä–æ–±–Ω–∏–∫:

```javascript
io.on('connection', function(socket) {
    console.log('üîå New socket connection:', socket.id);

    // –¢–µ—Å—Ç: –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫
    setTimeout(() => {
        socket.emit('private_message', {
            id: 999999,
            from_id: 1,
            to_id: 8,
            text: 'TEST MESSAGE FROM SERVER',
            time: Math.floor(Date.now() / 1000)
        });
        console.log('üì§ Sent test message to socket', socket.id);
    }, 5000);

    // ... —Ä–µ—à—Ç–∞ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
});
```

–Ø–∫—â–æ **—Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏–π–¥–µ** –Ω–∞ –∫–ª—ñ—î–Ω—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–æ–±–Ω–∏–∫—É `private_message`.
–Ø–∫—â–æ **–Ω–µ –ø—Ä–∏–π–¥–µ** - –ø—Ä–æ–±–ª–µ–º–∞ –∑ room –∞–±–æ –∑'—î–¥–Ω–∞–Ω–Ω—è–º.

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏:

- [ ] Node.js –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç—É 449
- [ ] Socket.IO –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –û–±—Ä–æ–±–Ω–∏–∫ `join` –ø—Ä–∞—Ü—é—î
- [ ] –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ room (`socket.join('user_X')`)
- [ ] –û–±—Ä–æ–±–Ω–∏–∫ `private_message` –æ—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ
- [ ] –ü–æ–¥—ñ—ó –µ–º—ñ—Ç—è—Ç—å—Å—è –¥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ room
- [ ] –§–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π (–º–∞—î –ø–æ–ª—è id, from_id, to_id, text, time)
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –µ–º—ñ—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π

## –§–∞–π–ª–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:

1. `nodejs/main.js` - –≥–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Socket.IO
2. `nodejs/listeners/listeners.js` - –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞
3. `nodejs/events/events.js` - –µ–º—ñ—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–æ –∫–ª—ñ—î–Ω—Ç–∞
4. `nodejs/config.json` - –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø–æ—Ä—Ç—ñ–≤ —Ç–∞ SSL

---

**–°—Ç–≤–æ—Ä–µ–Ω–æ:** 2025-12-26
**–ê–≤—Ç–æ—Ä:** Claude Code Agent

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ Node.js —Å–µ—Ä–≤–µ—Ä–∞
2. –î–æ–¥–∞–π—Ç–µ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
3. –ù–∞–¥—ñ—à–ª—ñ—Ç—å –º–µ–Ω—ñ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∫–æ–ª–∏ –Ω–∞–¥—Å–∏–ª–∞—î—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
4. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ - –Ω–∞–¥—ñ—à–ª—ñ—Ç—å `listeners.js` —Ç–∞ `events.js` –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É
