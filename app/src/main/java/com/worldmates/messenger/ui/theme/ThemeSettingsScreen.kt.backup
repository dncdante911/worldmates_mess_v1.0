package com.worldmates.messenger.ui.theme

import android.net.Uri
import android.os.Build
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.animateColorAsState
import androidx.compose.animation.core.Spring
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.animation.core.spring
import androidx.compose.animation.core.tween
import androidx.compose.animation.expandVertically
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.DarkMode
import androidx.compose.material.icons.filled.Image
import androidx.compose.material.icons.filled.LightMode
import androidx.compose.material.icons.filled.Palette
import androidx.compose.material.icons.filled.Wallpaper
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.RadioButton
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Switch
import androidx.compose.material3.SwitchDefaults
import androidx.compose.material3.Text
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.TopAppBarDefaults
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import coil.compose.AsyncImage
import com.worldmates.messenger.ui.preferences.BubbleStyle
import com.worldmates.messenger.ui.preferences.rememberBubbleStyle
import com.worldmates.messenger.ui.preferences.UIStylePreferences

/**
 * –ì–æ—Ç–æ–≤—ñ —Ñ–æ–Ω–æ–≤—ñ –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏ –¥–ª—è —á–∞—Ç—ñ–≤
 */
enum class PresetBackground(
    val id: String,
    val displayName: String,
    val gradientColors: List<Color>
) {
    OCEAN(
        id = "ocean",
        displayName = "–û–∫–µ–∞–Ω",
        gradientColors = listOf(Color(0xFF667eea), Color(0xFF764ba2))
    ),
    SUNSET(
        id = "sunset",
        displayName = "–ó–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è",
        gradientColors = listOf(Color(0xFFf83600), Color(0xFFf9d423))
    ),
    FOREST(
        id = "forest",
        displayName = "–õ—ñ—Å",
        gradientColors = listOf(Color(0xFF11998e), Color(0xFF38ef7d))
    ),
    LAVENDER(
        id = "lavender",
        displayName = "–õ–∞–≤–∞–Ω–¥–∞",
        gradientColors = listOf(Color(0xFFa8edea), Color(0xFFfed6e3))
    ),
    MIDNIGHT(
        id = "midnight",
        displayName = "–û–ø—ñ–≤–Ω–æ—á—ñ",
        gradientColors = listOf(Color(0xFF2c3e50), Color(0xFF3498db))
    ),
    PEACH(
        id = "peach",
        displayName = "–ü–µ—Ä—Å–∏–∫",
        gradientColors = listOf(Color(0xFFffecd2), Color(0xFFfcb69f))
    ),
    FIRE(
        id = "fire",
        displayName = "–í–æ–≥–æ–Ω—å",
        gradientColors = listOf(Color(0xFFFF0000), Color(0xFFFF7F00), Color(0xFFFFFF00))
    ),
    AURORA(
        id = "aurora",
        displayName = "–ü–æ–ª—è—Ä–Ω–µ —Å—è–π–≤–æ",
        gradientColors = listOf(Color(0xFF00FFA3), Color(0xFF03E1FF), Color(0xFFDC1FFF))
    ),
    CHERRY(
        id = "cherry",
        displayName = "–í–∏—à–Ω—è",
        gradientColors = listOf(Color(0xFFEB3349), Color(0xFFF45C43))
    ),
    COSMIC(
        id = "cosmic",
        displayName = "–ö–æ—Å–º–æ—Å",
        gradientColors = listOf(Color(0xFF8E2DE2), Color(0xFF4A00E0))
    );

    companion object {
        fun fromId(id: String?): PresetBackground? {
            return values().find { it.id == id }
        }
    }
}

/**
 * –ï–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ThemeSettingsScreen(
    onBackClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val themeViewModel = rememberThemeViewModel()
    val themeState = rememberThemeState()

    // –õ–∞—É–Ω—á–µ—Ä –¥–ª—è –≤–∏–±–æ—Ä—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    val imagePickerLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.GetContent()
    ) { uri: Uri? ->
        uri?.let {
            android.util.Log.d("ThemeSettings", "User selected background image: $it")
            themeViewModel.setBackgroundImageUri(it.toString())
            android.util.Log.d("ThemeSettings", "setBackgroundImageUri called with: ${it.toString()}")
        }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "–¢–µ–º—ã –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
                        fontWeight = FontWeight.SemiBold
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(
                            imageVector = Icons.Default.ArrowBack,
                            contentDescription = "–ù–∞–∑–∞–¥"
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primary,
                    titleContentColor = MaterialTheme.colorScheme.onPrimary,
                    navigationIconContentColor = MaterialTheme.colorScheme.onPrimary
                )
            )
        }
    ) { paddingValues ->
        LazyColumn(
            modifier = modifier
                .fillMaxSize()
                .padding(paddingValues),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // –°–µ–∫—Ü–∏—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            item {
                ThemeModeSectionCard(
                    themeState = themeState,
                    viewModel = themeViewModel
                )
            }

            // –°–µ–∫—Ü–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            item {
                BackgroundImageSection(
                    currentBackgroundUri = themeState.backgroundImageUri,
                    currentPresetId = themeState.presetBackgroundId,
                    onSelectImage = {
                        android.util.Log.d("ThemeSettings", "Opening image picker for background")
                        imagePickerLauncher.launch("image/*")
                    },
                    onRemoveImage = {
                        android.util.Log.d("ThemeSettings", "Removing background")
                        themeViewModel.setBackgroundImageUri(null)
                        themeViewModel.setPresetBackgroundId(null)
                    },
                    onSelectPreset = { presetId ->
                        android.util.Log.d("ThemeSettings", "User selected preset background: $presetId")
                        themeViewModel.setPresetBackgroundId(presetId)
                        android.util.Log.d("ThemeSettings", "setPresetBackgroundId called with: $presetId")
                    }
                )
            }

            // –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (WorldMates/Telegram)
            item {
                UIStyleSection()
            }

            // –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –±—É–ª—å–±–∞—à–æ–∫
            item {
                BubbleStyleSection()
            }

            // –°–µ–∫—Ü—ñ—è –≤–∏–±–æ—Ä—É —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
            item {
                QuickReactionSection()
            }

            // –°–µ–∫—Ü—ñ—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ —Ç–∞ –∫–∞—Å—Ç–æ–º—ñ–∑–∞—Ü—ñ—ó
            item {
                AdvancedCustomizationSection()
            }

            // –°–µ—Ç–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç–µ–º
            item {
                Column {
                    Text(
                        text = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold,
                        modifier = Modifier.padding(bottom = 12.dp)
                    )

                    ThemeVariantsGrid(
                        selectedVariant = themeState.variant,
                        onVariantSelected = { themeViewModel.setThemeVariant(it) }
                    )
                }
            }
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ç–µ–º—ã (—Å–≤–µ—Ç–ª–∞—è/—Ç–µ–º–Ω–∞—è/—Å–∏—Å—Ç–µ–º–Ω–∞—è)
 */
@Composable
fun ThemeModeSectionCard(
    themeState: ThemeState,
    viewModel: ThemeViewModel
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(verticalAlignment = Alignment.CenterVertically) {
                    Icon(
                        imageVector = if (themeState.isDark) Icons.Default.DarkMode else Icons.Default.LightMode,
                        contentDescription = null,
                        tint = MaterialTheme.colorScheme.primary,
                        modifier = Modifier.size(24.dp)
                    )
                    Spacer(modifier = Modifier.width(12.dp))
                    Text(
                        text = "–¢–µ–º–Ω–∞—è —Ç–µ–º–∞",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Medium
                    )
                }

                Switch(
                    checked = themeState.isDark,
                    onCheckedChange = { viewModel.toggleDarkTheme() },
                    enabled = !themeState.useSystemTheme,
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = MaterialTheme.colorScheme.primary,
                        checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                    )
                )
            }

            Spacer(modifier = Modifier.height(12.dp))

            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { viewModel.toggleSystemTheme() },
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–°–ª–µ–¥–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º–µ",
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–¢–µ–º–∞ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                Switch(
                    checked = themeState.useSystemTheme,
                    onCheckedChange = { viewModel.toggleSystemTheme() },
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = MaterialTheme.colorScheme.primary,
                        checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                    )
                )
            }
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ Material You
 */
@Composable
fun MaterialYouCard(
    enabled: Boolean,
    onToggle: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (enabled) {
                MaterialTheme.colorScheme.primaryContainer
            } else {
                MaterialTheme.colorScheme.surface
            }
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(onClick = onToggle)
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(
                modifier = Modifier.weight(1f),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Icon(
                    imageVector = Icons.Default.Palette,
                    contentDescription = null,
                    tint = if (enabled) {
                        MaterialTheme.colorScheme.onPrimaryContainer
                    } else {
                        MaterialTheme.colorScheme.primary
                    },
                    modifier = Modifier.size(24.dp)
                )
                Spacer(modifier = Modifier.width(12.dp))
                Column {
                    Text(
                        text = "Material You üé®",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "–¶–≤–µ—Ç–∞ –∏–∑ –≤–∞—à–∏—Ö –æ–±–æ–µ–≤",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            Switch(
                checked = enabled,
                onCheckedChange = { onToggle() },
                colors = SwitchDefaults.colors(
                    checkedThumbColor = MaterialTheme.colorScheme.primary,
                    checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                )
            )
        }
    }
}

/**
 * –°–µ—Ç–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç–µ–º
 */
@Composable
fun ThemeVariantsGrid(
    selectedVariant: ThemeVariant,
    onVariantSelected: (ThemeVariant) -> Unit
) {
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ–º—ã: Material You —Ç–æ–ª—å–∫–æ –Ω–∞ Android 12+
    val availableThemes = ThemeVariant.values().filter { variant ->
        if (variant == ThemeVariant.MATERIAL_YOU) {
            Build.VERSION.SDK_INT >= Build.VERSION_CODES.S
        } else {
            true
        }
    }

    LazyVerticalGrid(
        columns = GridCells.Fixed(2),
        modifier = Modifier.height(600.dp),
        horizontalArrangement = Arrangement.spacedBy(12.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        items(availableThemes) { variant ->
            ThemeVariantCard(
                variant = variant,
                isSelected = variant == selectedVariant,
                onClick = { onVariantSelected(variant) }
            )
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç–µ–º—ã
 */
@Composable
fun ThemeVariantCard(
    variant: ThemeVariant,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val palette = variant.getPalette()
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.05f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "scale"
    )

    val borderColor by animateColorAsState(
        targetValue = if (isSelected) palette.primary else Color.Transparent,
        animationSpec = tween(300),
        label = "borderColor"
    )

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .scale(scale)
            .border(
                width = if (isSelected) 3.dp else 0.dp,
                color = borderColor,
                shape = RoundedCornerShape(16.dp)
            )
            .clickable(
                onClick = onClick,
                indication = null,
                interactionSource = remember { MutableInteractionSource() }
            ),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 8.dp else 4.dp
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(12.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Emoji
            Text(
                text = variant.emoji,
                fontSize = 32.sp,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            // –ù–∞–∑–≤–∞–Ω–∏–µ
            Text(
                text = variant.displayName,
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                textAlign = TextAlign.Center,
                modifier = Modifier.padding(bottom = 4.dp)
            )

            // –û–ø–∏—Å–∞–Ω–∏–µ
            Text(
                text = variant.description,
                style = MaterialTheme.typography.bodySmall,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            // –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.Center,
                verticalAlignment = Alignment.CenterVertically
            ) {
                ColorCircle(color = palette.primary)
                Spacer(modifier = Modifier.width(4.dp))
                ColorCircle(color = palette.secondary)
                Spacer(modifier = Modifier.width(4.dp))
                ColorCircle(color = palette.accent)
            }

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±–æ—Ä–∞
            if (isSelected) {
                Spacer(modifier = Modifier.height(8.dp))
                Row(
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = Icons.Default.CheckCircle,
                        contentDescription = "–í—ã–±—Ä–∞–Ω–æ",
                        tint = palette.primary,
                        modifier = Modifier.size(20.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = "–í—ã–±—Ä–∞–Ω–æ",
                        style = MaterialTheme.typography.labelSmall,
                        color = palette.primary,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
        }
    }
}

/**
 * –¶–≤–µ—Ç–Ω–æ–π –∫—Ä—É–∂–æ–∫ –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã
 */
@Composable
fun ColorCircle(color: Color) {
    Box(
        modifier = Modifier
            .size(24.dp)
            .clip(CircleShape)
            .background(color)
            .border(
                width = 1.dp,
                color = Color.White.copy(alpha = 0.3f),
                shape = CircleShape
            )
    )
}

/**
 * –°–µ–∫—Ü—ñ—è –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–æ–Ω–æ–≤–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
 */
@Composable
fun BackgroundImageSection(
    currentBackgroundUri: String?,
    currentPresetId: String?,
    onSelectImage: () -> Unit,
    onRemoveImage: () -> Unit,
    onSelectPreset: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.padding(bottom = 12.dp)
            ) {
                Icon(
                    imageVector = Icons.Default.Wallpaper,
                    contentDescription = null,
                    tint = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.size(24.dp)
                )
                Spacer(modifier = Modifier.width(12.dp))
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.SemiBold
                    )
                    Text(
                        text = "–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —á–∞—Ç–æ–≤",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            // –ü—Ä–µ–≤—å—é —Ç–µ–∫—É—â–µ–≥–æ —Ñ–æ–Ω–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
            if (currentBackgroundUri != null) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(150.dp)
                        .clip(RoundedCornerShape(12.dp))
                ) {
                    AsyncImage(
                        model = Uri.parse(currentBackgroundUri),
                        contentDescription = "Background preview",
                        modifier = Modifier.fillMaxSize(),
                        contentScale = ContentScale.Crop
                    )

                    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
                    IconButton(
                        onClick = onRemoveImage,
                        modifier = Modifier
                            .align(Alignment.TopEnd)
                            .padding(8.dp)
                            .background(
                                color = MaterialTheme.colorScheme.errorContainer.copy(alpha = 0.9f),
                                shape = CircleShape
                            )
                    ) {
                        Icon(
                            imageVector = Icons.Default.Close,
                            contentDescription = "–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω",
                            tint = MaterialTheme.colorScheme.onErrorContainer
                        )
                    }
                }
            } else {
                // –ó–∞–≥–ª—É—à–∫–∞ - –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(120.dp)
                        .clip(RoundedCornerShape(12.dp))
                        .background(MaterialTheme.colorScheme.surfaceVariant),
                    contentAlignment = Alignment.Center
                ) {
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.Center
                    ) {
                        Icon(
                            imageVector = Icons.Default.Image,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f),
                            modifier = Modifier.size(48.dp)
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            text = "–ù–µ—Ç —Ñ–æ–Ω–∞",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.7f)
                        )
                    }
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –ì–æ—Ç–æ–≤—ñ —Ñ–æ–Ω–æ–≤—ñ –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏
            Text(
                text = "–ì–æ—Ç–æ–≤—ñ —Ñ–æ–Ω–∏",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                modifier = Modifier.height(220.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(PresetBackground.values()) { preset ->
                    PresetBackgroundCard(
                        preset = preset,
                        isSelected = preset.id == currentPresetId,
                        onClick = { onSelectPreset(preset.id) }
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            Button(
                onClick = onSelectImage,
                modifier = Modifier.fillMaxWidth(),
                colors = ButtonDefaults.buttonColors(
                    containerColor = MaterialTheme.colorScheme.primary
                )
            ) {
                Icon(
                    imageVector = Icons.Default.Image,
                    contentDescription = null,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = if (currentBackgroundUri != null) "–ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ–Ω" else "–í–∏–±—Ä–∞—Ç–∏ —Ñ–æ–Ω",
                    fontWeight = FontWeight.SemiBold
                )
            }
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ —Ñ–æ–Ω–æ–≤–æ–≥–æ –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞
 */
@Composable
fun PresetBackgroundCard(
    preset: PresetBackground,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.05f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessMedium
        )
    )

    val borderColor by animateColorAsState(
        targetValue = if (isSelected) {
            MaterialTheme.colorScheme.primary
        } else {
            Color.Transparent
        },
        animationSpec = tween(300)
    )

    Box(
        modifier = modifier
            .scale(scale)
            .clip(RoundedCornerShape(12.dp))
            .border(
                width = 3.dp,
                color = borderColor,
                shape = RoundedCornerShape(12.dp)
            )
            .clickable(onClick = onClick)
    ) {
        // –ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π —Ñ–æ–Ω
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(
                    brush = Brush.linearGradient(
                        colors = preset.gradientColors
                    ),
                    shape = RoundedCornerShape(12.dp)
                )
                .height(70.dp)
        )

        // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–±—Ä–∞–Ω–æ–≥–æ —Ñ–æ–Ω—É
        if (isSelected) {
            Icon(
                imageVector = Icons.Default.CheckCircle,
                contentDescription = "–í–∏–±—Ä–∞–Ω–æ",
                tint = Color.White,
                modifier = Modifier
                    .align(Alignment.Center)
                    .size(32.dp)
                    .background(
                        color = MaterialTheme.colorScheme.primary.copy(alpha = 0.8f),
                        shape = CircleShape
                    )
                    .padding(4.dp)
            )
        }

        // –ù–∞–∑–≤–∞ —Ñ–æ–Ω—É
        Text(
            text = preset.displayName,
            color = Color.White,
            fontSize = 11.sp,
            fontWeight = FontWeight.Bold,
            textAlign = TextAlign.Center,
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .fillMaxWidth()
                .background(
                    brush = Brush.verticalGradient(
                        colors = listOf(
                            Color.Transparent,
                            Color.Black.copy(alpha = 0.6f)
                        )
                    )
                )
                .padding(vertical = 4.dp)
        )
    }
}

/**
 * –°–µ–∫—Ü—ñ—è –¥–ª—è –≤–∏–±–æ—Ä—É —Å—Ç–∏–ª—é —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
 */
@Composable
fun UIStyleSection() {
    val context = LocalContext.current
    val currentStyle = com.worldmates.messenger.ui.preferences.rememberUIStyle()

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        ),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Text(
                text = "–°—Ç–∏–ª—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            Text(
                text = "–û–±–µ—Ä—ñ—Ç—å —Å—Ç–∏–ª—å –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–∞—Ç—ñ–≤ —Ç–∞ –≥—Ä—É–ø",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 16.dp)
            )

            // WorldMates —Å—Ç–∏–ª—å
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clip(RoundedCornerShape(12.dp))
                    .clickable {
                        com.worldmates.messenger.ui.preferences.UIStylePreferences.setStyle(
                            context,
                            com.worldmates.messenger.ui.preferences.UIStyle.WORLDMATES
                        )
                    }
                    .background(
                        if (currentStyle == com.worldmates.messenger.ui.preferences.UIStyle.WORLDMATES)
                            MaterialTheme.colorScheme.primaryContainer
                        else
                            MaterialTheme.colorScheme.surface
                    )
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                RadioButton(
                    selected = currentStyle == com.worldmates.messenger.ui.preferences.UIStyle.WORLDMATES,
                    onClick = {
                        com.worldmates.messenger.ui.preferences.UIStylePreferences.setStyle(
                            context,
                            com.worldmates.messenger.ui.preferences.UIStyle.WORLDMATES
                        )
                    }
                )

                Spacer(modifier = Modifier.width(12.dp))

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "WorldMates",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–ö–∞—Ä—Ç–∫–∏ –∑ –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞–º–∏ —Ç–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è–º–∏",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            Spacer(modifier = Modifier.height(8.dp))

            // Telegram —Å—Ç–∏–ª—å
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clip(RoundedCornerShape(12.dp))
                    .clickable {
                        com.worldmates.messenger.ui.preferences.UIStylePreferences.setStyle(
                            context,
                            com.worldmates.messenger.ui.preferences.UIStyle.TELEGRAM
                        )
                    }
                    .background(
                        if (currentStyle == com.worldmates.messenger.ui.preferences.UIStyle.TELEGRAM)
                            MaterialTheme.colorScheme.primaryContainer
                        else
                            MaterialTheme.colorScheme.surface
                    )
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                RadioButton(
                    selected = currentStyle == com.worldmates.messenger.ui.preferences.UIStyle.TELEGRAM,
                    onClick = {
                        com.worldmates.messenger.ui.preferences.UIStylePreferences.setStyle(
                            context,
                            com.worldmates.messenger.ui.preferences.UIStyle.TELEGRAM
                        )
                    }
                )

                Spacer(modifier = Modifier.width(12.dp))

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–ö–ª–∞—Å–∏—á–Ω–∏–π",
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–ú—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π –∫–ª–∞—Å–∏—á–Ω–∏–π —Å—Ç–∏–ª—å",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }
    }
}

/**
 * üé® –°–µ–∫—Ü—ñ—è –¥–ª—è –≤–∏–±–æ—Ä—É —Å—Ç–∏–ª—é –±—É–ª—å–±–∞—à–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
 */
@Composable
fun BubbleStyleSection() {
    val context = LocalContext.current
    val currentBubbleStyle = rememberBubbleStyle()

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        ),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Text(
                text = "üé® –°—Ç–∏–ª—å –±—É–ª—å–±–∞—à–æ–∫",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            Text(
                text = "–û–±–µ—Ä—ñ—Ç—å –¥–∏–∑–∞–π–Ω –±—É–ª—å–±–∞—à–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 16.dp)
            )

            // –°—ñ—Ç–∫–∞ –∑ 6 —Å—Ç–∏–ª—è–º–∏ –±—É–ª—å–±–∞—à–æ–∫
            LazyVerticalGrid(
                columns = GridCells.Fixed(2),
                modifier = Modifier.height(400.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(BubbleStyle.values()) { style ->
                    BubbleStyleCard(
                        bubbleStyle = style,
                        isSelected = style == currentBubbleStyle,
                        onClick = {
                            UIStylePreferences.setBubbleStyle(context, style)
                        }
                    )
                }
            }
        }
    }
}

/**
 * üí¨ –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –≤–∏–±–æ—Ä—É —Å—Ç–∏–ª—é –±—É–ª—å–±–∞—à–∫–∏
 */
@Composable
fun BubbleStyleCard(
    bubbleStyle: BubbleStyle,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.05f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "scale"
    )

    val borderColor by animateColorAsState(
        targetValue = if (isSelected) MaterialTheme.colorScheme.primary else Color.Transparent,
        animationSpec = tween(300),
        label = "borderColor"
    )

    Card(
        modifier = modifier
            .fillMaxWidth()
            .scale(scale)
            .border(
                width = if (isSelected) 3.dp else 0.dp,
                color = borderColor,
                shape = RoundedCornerShape(16.dp)
            )
            .clickable(
                onClick = onClick,
                indication = null,
                interactionSource = remember { MutableInteractionSource() }
            ),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 8.dp else 4.dp
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(12.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // –Ü–∫–æ–Ω–∫–∞ —Å—Ç–∏–ª—é
            Text(
                text = bubbleStyle.icon,
                fontSize = 32.sp,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            // –ù–∞–∑–≤–∞ —Å—Ç–∏–ª—é
            Text(
                text = bubbleStyle.displayName,
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                textAlign = TextAlign.Center,
                modifier = Modifier.padding(bottom = 4.dp)
            )

            // –û–ø–∏—Å —Å—Ç–∏–ª—é
            Text(
                text = bubbleStyle.description,
                style = MaterialTheme.typography.bodySmall,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–±–æ—Ä—É
            if (isSelected) {
                Spacer(modifier = Modifier.height(8.dp))
                Row(
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        imageVector = Icons.Default.CheckCircle,
                        contentDescription = "–í–∏–±—Ä–∞–Ω–æ",
                        tint = MaterialTheme.colorScheme.primary,
                        modifier = Modifier.size(20.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = "–í–∏–±—Ä–∞–Ω–æ",
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.primary,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
        }
    }
}

/**
 * ‚ù§Ô∏è –°–µ–∫—Ü—ñ—è –¥–ª—è –≤–∏–±–æ—Ä—É –µ–º–æ–¥–∑—ñ —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
 */
@Composable
fun QuickReactionSection() {
    val context = LocalContext.current
    val currentQuickReaction by UIStylePreferences.quickReaction.collectAsState()

    // –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –µ–º–æ–¥–∑—ñ –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
    val popularEmojis = listOf(
        "‚ù§Ô∏è", "üëç", "üëé", "üòÇ", "üòÆ", "üò¢",
        "üî•", "‚ú®", "üéâ", "üíØ", "üëè", "üôè"
    )

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        ),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Text(
                text = "‚ù§Ô∏è –®–≤–∏–¥–∫–∞ —Ä–µ–∞–∫—Ü—ñ—è",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            Text(
                text = "–û–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ –¥–ª—è –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ —Ç–∞–ø—É –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 16.dp)
            )

            // –°—ñ—Ç–∫–∞ –∑ –µ–º–æ–¥–∑—ñ
            LazyVerticalGrid(
                columns = GridCells.Fixed(6),
                modifier = Modifier.height(160.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(popularEmojis) { emoji ->
                    EmojiReactionCard(
                        emoji = emoji,
                        isSelected = emoji == currentQuickReaction,
                        onClick = {
                            UIStylePreferences.setQuickReaction(context, emoji)
                        }
                    )
                }
            }
        }
    }
}

/**
 * ‚ù§Ô∏è –ö–∞—Ä—Ç–æ—á–∫–∞ –µ–º–æ–¥–∑—ñ –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
 */
@Composable
fun EmojiReactionCard(
    emoji: String,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.2f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "scale"
    )

    val borderColor by animateColorAsState(
        targetValue = if (isSelected) MaterialTheme.colorScheme.primary else Color.Transparent,
        animationSpec = tween(300),
        label = "borderColor"
    )

    Card(
        modifier = Modifier
            .size(48.dp)
            .scale(scale)
            .border(
                width = if (isSelected) 2.dp else 0.dp,
                color = borderColor,
                shape = RoundedCornerShape(12.dp)
            )
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) {
                MaterialTheme.colorScheme.primaryContainer
            } else {
                MaterialTheme.colorScheme.surface
            }
        ),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 4.dp else 2.dp
        )
    ) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = emoji,
                fontSize = 24.sp
            )
        }
    }
}

/**
 * ‚ú® –°–µ–∫—Ü—ñ—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ —Ç–∞ –∫–∞—Å—Ç–æ–º—ñ–∑–∞—Ü—ñ—ó
 */
@Composable
fun AdvancedCustomizationSection() {
    val context = LocalContext.current
    val customizationViewModel = remember {
        CustomizationManager.getViewModel(context)
    }
    val customizationState by customizationViewModel.customizationState.collectAsState()

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        ),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü—ñ—ó
            Text(
                text = "‚ú® –î–æ–¥–∞—Ç–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            Text(
                text = "–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ —Ç–∞ –∞–Ω—ñ–º–∞—Ü—ñ—ó",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(bottom = 16.dp)
            )

            // –®–≤–∏–¥–∫—ñ –ø—Ä–µ—Å–µ—Ç–∏
            QuickPresetsSection(customizationViewModel)

            Spacer(modifier = Modifier.height(16.dp))

            // –°—Ç–∏–ª—å –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
            Text(
                text = "üí¨ –í—ñ–∑—É–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                modifier = Modifier.height(600.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(MessageBubbleStyle.values()) { style ->
                    MessageBubbleStyleCard(
                        style = style,
                        isSelected = style == customizationState.bubbleStyle,
                        onClick = { customizationViewModel.setBubbleStyle(style) }
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –°—Ç–∏–ª—å –∞–Ω—ñ–º–∞—Ü—ñ–π
            Text(
                text = "üé¨ –°—Ç–∏–ª—å –∞–Ω—ñ–º–∞—Ü—ñ–π",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                modifier = Modifier.height(240.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(MessageAnimationStyle.values()) { style ->
                    AnimationStyleCard(
                        style = style,
                        isSelected = style == customizationState.animationStyle,
                        onClick = { customizationViewModel.setAnimationStyle(style) }
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –í–∞—Ä—ñ–∞–Ω—Ç —à—Ä–∏—Ñ—Ç—É
            Text(
                text = "üî§ –®—Ä–∏—Ñ—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 8.dp)
            )

            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                modifier = Modifier.height(720.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(FontVariant.values()) { variant ->
                    FontVariantCard(
                        variant = variant,
                        isSelected = variant == customizationState.fontVariant,
                        onClick = { customizationViewModel.setFontVariant(variant) }
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –ü–µ—Ä–µ–º–∏–∫–∞—á—ñ –µ—Ñ–µ–∫—Ç—ñ–≤
            Text(
                text = "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –µ—Ñ–µ–∫—Ç—ñ–≤",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                modifier = Modifier.padding(bottom = 12.dp)
            )

            // Particle Effects
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–ï—Ñ–µ–∫—Ç–∏ —á–∞—Å—Ç–∏–Ω–æ–∫",
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –µ—Ñ–µ–∫—Ç–∏",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                Switch(
                    checked = customizationState.enableParticleEffects,
                    onCheckedChange = { customizationViewModel.toggleParticleEffects() },
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = MaterialTheme.colorScheme.primary,
                        checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                    )
                )
            }

            // Message Animations
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–ê–Ω—ñ–º–∞—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å",
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–ü–ª–∞–≤–Ω–∞ –ø–æ—è–≤–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                Switch(
                    checked = customizationState.enableMessageAnimations,
                    onCheckedChange = { customizationViewModel.toggleMessageAnimations() },
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = MaterialTheme.colorScheme.primary,
                        checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                    )
                )
            }

            // Smooth Scrolling
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "–ü–ª–∞–≤–Ω–µ –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è",
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "–ú'—è–∫–µ –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }

                Switch(
                    checked = customizationState.enableSmoothScrolling,
                    onCheckedChange = { customizationViewModel.toggleSmoothScrolling() },
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = MaterialTheme.colorScheme.primary,
                        checkedTrackColor = MaterialTheme.colorScheme.primaryContainer
                    )
                )
            }

            Spacer(modifier = Modifier.height(16.dp))

            // –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è
            OutlinedButton(
                onClick = { customizationViewModel.resetToDefaults() },
                modifier = Modifier.fillMaxWidth(),
                colors = ButtonDefaults.outlinedButtonColors(
                    contentColor = MaterialTheme.colorScheme.primary
                )
            ) {
                Text(
                    text = "–°–∫–∏–Ω—É—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                    fontWeight = FontWeight.Medium
                )
            }
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∏–ª—é –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
 */
@Composable
fun MessageBubbleStyleCard(
    style: MessageBubbleStyle,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.08f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessMedium
        ),
        label = "scale"
    )

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(135.dp)
            .scale(scale)
            .border(
                width = if (isSelected) 2.5.dp else 0.5.dp,
                color = if (isSelected) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.outline.copy(alpha = 0.3f),
                shape = RoundedCornerShape(12.dp)
            )
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected)
                MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
            else
                MaterialTheme.colorScheme.surface
        ),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 6.dp else 2.dp
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(8.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            // Preview bubble
            Box(
                modifier = style.getModifier(
                    isOwn = true,
                    primaryColor = MaterialTheme.colorScheme.primary,
                    secondaryColor = MaterialTheme.colorScheme.surfaceVariant
                )
                    .size(width = 50.dp, height = 22.dp),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = style.emoji,
                    fontSize = 12.sp,
                    color = MaterialTheme.colorScheme.onPrimary
                )
            }

            Spacer(modifier = Modifier.height(4.dp))

            Text(
                text = style.displayName,
                style = MaterialTheme.typography.labelMedium,
                fontWeight = if (isSelected) FontWeight.Bold else FontWeight.SemiBold,
                textAlign = TextAlign.Center,
                fontSize = 11.sp,
                maxLines = 1,
                modifier = Modifier.padding(bottom = 2.dp)
            )

            Text(
                text = style.description,
                style = MaterialTheme.typography.bodySmall,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                fontSize = 9.sp,
                maxLines = 2,
                lineHeight = 11.sp
            )

            if (isSelected) {
                Spacer(modifier = Modifier.height(4.dp))
                Icon(
                    imageVector = Icons.Default.Check,
                    contentDescription = "–í–∏–±—Ä–∞–Ω–æ",
                    tint = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.size(16.dp)
                )
            }
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∏–ª—é –∞–Ω—ñ–º–∞—Ü—ñ–π
 */
@Composable
fun AnimationStyleCard(
    style: MessageAnimationStyle,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.1f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "scale"
    )

    val borderColor by animateColorAsState(
        targetValue = if (isSelected) MaterialTheme.colorScheme.primary else Color.Transparent,
        animationSpec = tween(300),
        label = "borderColor"
    )

    Card(
        modifier = Modifier
            .size(90.dp)
            .scale(scale)
            .border(
                width = if (isSelected) 2.dp else 0.dp,
                color = borderColor,
                shape = RoundedCornerShape(12.dp)
            )
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) {
                MaterialTheme.colorScheme.primaryContainer
            } else {
                MaterialTheme.colorScheme.surface
            }
        ),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 4.dp else 2.dp
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(8.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Text(
                text = style.emoji,
                fontSize = 24.sp,
                modifier = Modifier.padding(bottom = 4.dp)
            )

            Text(
                text = style.displayName,
                style = MaterialTheme.typography.bodySmall,
                fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Medium,
                textAlign = TextAlign.Center,
                fontSize = 10.sp
            )
        }
    }
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—É —à—Ä–∏—Ñ—Ç—É
 */
@Composable
fun FontVariantCard(
    variant: FontVariant,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.06f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessMedium
        ),
        label = "scale"
    )

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(110.dp)
            .scale(scale)
            .border(
                width = if (isSelected) 2.5.dp else 0.5.dp,
                color = if (isSelected) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.outline.copy(alpha = 0.3f),
                shape = RoundedCornerShape(12.dp)
            )
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected)
                MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
            else
                MaterialTheme.colorScheme.surface
        ),
        elevation = CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 6.dp else 2.dp
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(6.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Text(
                text = variant.emoji,
                fontSize = 24.sp,
                modifier = Modifier.padding(bottom = 3.dp)
            )

            Text(
                text = variant.displayName,
                style = MaterialTheme.typography.labelSmall,
                fontWeight = if (isSelected) FontWeight.Bold else FontWeight.SemiBold,
                textAlign = TextAlign.Center,
                fontSize = 10.sp,
                maxLines = 1,
                modifier = Modifier.padding(bottom = 2.dp)
            )

            Text(
                text = variant.description,
                style = MaterialTheme.typography.bodySmall,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                fontSize = 8.sp,
                maxLines = 2,
                lineHeight = 9.sp
            )

            if (isSelected) {
                Spacer(modifier = Modifier.height(2.dp))
                Icon(
                    imageVector = Icons.Default.Check,
                    contentDescription = "–í–∏–±—Ä–∞–Ω–æ",
                    tint = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.size(14.dp)
                )
            }
        }
    }
}

/**
 * üéØ –®–≤–∏–¥–∫—ñ –ø—Ä–µ—Å–µ—Ç–∏ —Å—Ç–∏–ª—ñ–≤
 */
data class StylePreset(
    val name: String,
    val emoji: String,
    val description: String,
    val bubbleStyle: MessageBubbleStyle,
    val animationStyle: MessageAnimationStyle,
    val fontVariant: FontVariant
)

val quickPresets = listOf(
    StylePreset(
        name = "Cyberpunk",
        emoji = "üåÉ",
        description = "Neon + Futuristic + Fira Code",
        bubbleStyle = MessageBubbleStyle.NEON,
        animationStyle = MessageAnimationStyle.FADE,
        fontVariant = FontVariant.FIRA_CODE
    ),
    StylePreset(
        name = "Retro Wave",
        emoji = "üìº",
        description = "Retro + Wave + Special Elite",
        bubbleStyle = MessageBubbleStyle.RETRO,
        animationStyle = MessageAnimationStyle.WAVE,
        fontVariant = FontVariant.SPECIAL_ELITE
    ),
    StylePreset(
        name = "Minimal Zen",
        emoji = "‚òØÔ∏è",
        description = "Minimal + Fade + Raleway",
        bubbleStyle = MessageBubbleStyle.MINIMAL,
        animationStyle = MessageAnimationStyle.FADE,
        fontVariant = FontVariant.RALEWAY
    ),
    StylePreset(
        name = "Comic Pop",
        emoji = "üí•",
        description = "Comic + Bounce + Architects Daughter",
        bubbleStyle = MessageBubbleStyle.COMIC,
        animationStyle = MessageAnimationStyle.BOUNCE,
        fontVariant = FontVariant.ARCHITECTS_DAUGHTER
    ),
    StylePreset(
        name = "Glass Blur",
        emoji = "ü™ü",
        description = "Glass + Slide + Poppins",
        bubbleStyle = MessageBubbleStyle.GLASS,
        animationStyle = MessageAnimationStyle.SLIDE,
        fontVariant = FontVariant.POPPINS
    ),
    StylePreset(
        name = "Soft Neo",
        emoji = "üé≠",
        description = "Neumorphism + Scale + Comfortaa",
        bubbleStyle = MessageBubbleStyle.NEUMORPHISM,
        animationStyle = MessageAnimationStyle.SCALE,
        fontVariant = FontVariant.COMFORTAA
    )
)

@Composable
fun QuickPresetsSection(viewModel: CustomizationViewModel) {
    Column {
        Text(
            text = "‚ö° –®–≤–∏–¥–∫—ñ –ø—Ä–µ—Å–µ—Ç–∏",
            style = MaterialTheme.typography.titleSmall,
            fontWeight = FontWeight.SemiBold,
            modifier = Modifier.padding(bottom = 8.dp)
        )

        Text(
            text = "–ì–æ—Ç–æ–≤—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó —Å—Ç–∏–ª—ñ–≤ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –Ω–∞—Å—Ç—Ä–æ—ó–≤",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            modifier = Modifier.padding(bottom = 12.dp)
        )

        LazyVerticalGrid(
            columns = GridCells.Fixed(2),
            modifier = Modifier.height(240.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            items(quickPresets) { preset ->
                PresetCard(
                    preset = preset,
                    onClick = {
                        viewModel.setBubbleStyle(preset.bubbleStyle)
                        viewModel.setAnimationStyle(preset.animationStyle)
                        viewModel.setFontVariant(preset.fontVariant)
                    }
                )
            }
        }
    }
}

@Composable
fun PresetCard(
    preset: StylePreset,
    onClick: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(100.dp)
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.secondaryContainer
        ),
        elevation = CardDefaults.cardElevation(
            defaultElevation = 4.dp,
            pressedElevation = 8.dp
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxSize()
                .padding(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Emoji –≤ —Å—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω–æ–º—É –∫–æ–ª—ñ
            Box(
                modifier = Modifier
                    .size(48.dp)
                    .clip(CircleShape)
                    .background(
                        brush = Brush.radialGradient(
                            colors = listOf(
                                MaterialTheme.colorScheme.primary.copy(alpha = 0.2f),
                                MaterialTheme.colorScheme.primary.copy(alpha = 0.05f)
                            )
                        )
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = preset.emoji,
                    fontSize = 24.sp
                )
            }

            Spacer(modifier = Modifier.width(12.dp))

            Column(
                modifier = Modifier.weight(1f)
            ) {
                Text(
                    text = preset.name,
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSecondaryContainer
                )

                Spacer(modifier = Modifier.height(4.dp))

                Text(
                    text = preset.description,
                    style = MaterialTheme.typography.bodySmall,
                    fontSize = 10.sp,
                    maxLines = 2,
                    lineHeight = 12.sp,
                    color = MaterialTheme.colorScheme.onSecondaryContainer.copy(alpha = 0.7f)
                )
            }
        }
    }
}